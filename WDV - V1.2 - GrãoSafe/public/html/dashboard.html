<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link href='https://fonts.googleapis.com/css?family=Jost' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
    <title>GrãoSafe</title>

</head>
<body>

        <div class="container">
            <!-- <div class="img-bg">                   
            </div> -->
            <div class="sidebar"> 
                <div class="usuario">
                    <img src="../Imagens/usuario.png" class="img">
                </div>
                <div class="navbar-log">
                <b>
                <a href="dashboard.html"><span class="tsize1">Dashboards</span></a>
                <a href="#"><span class="tsize2">Sensores</span></a>
                <a href="#"><span class="tsize4">Suporte</span></a>
                <a href="notificações.html"><span class="tsize3">Notificações</span></a>
                </b>
            </div>
            
            <div class="sair">
                <b>
                <a href="home.html"><span class="tsize">Sair</span></a>
                </b>
            </div>
        </div>

                <div class="conteudo"> 
                    <div class="grafico">
                        <h1 class="tituloPrinc">Dashboard GrãoSafe</h1>
                        <div class="grafico-caixa-pai">
                            
                            <div class="kpis_container">
                                    
                                    <div class="grafico-caixa">
                                        <h1 class="tituloDiario">Temperatura média diária</h1>
                                        <h2 class="temp-media" id="temp_atual_media"></h2>
                                    </div>
                                    
                                    <div class="grafico-caixa">
                                        <h1 class="tituloAlerta">Alertas totais diários</h1>
                                        <h2 class="alertas" id="alerta_kpi">0</h2>
                                    </div>
                                    
                                    <div class="grafico-caixa">
                                        <h1 class="tituloAtual">Temperatura atual</h1>
                                        <h2 class="temp-atual" id="temp_atual">27°C</h2>
                                    </div>
                                    
                            </div>


                            <div class="caixa_principal">
                                <div class="caixa_dash2">
                                    <canvas id="Grafico3" class="grafico3" style="height: 200px; width: 100%; background-color: rgb(209, 203, 203);  border-radius: 6px;"></canvas>
                                </div>
                                <div class="caixa_dash1">
                                    
                                    <div class="grafico-caixa1">
                                        <h3 class="tituloDiaria">Temperatura diária</h1>
                                            <canvas id="Grafico1" class="grafico1" style="height: 280px; width: 100%; background-color: rgb(209, 203, 203);"></canvas>
                                    </div>
                                    
                                    <div class="grafico-caixa-pizza">
                                        <h1 class="tituloMensal">Relatório mensal de temperatura</h1>
                                            <canvas id="Grafico2" class="grafico2" style="height: 80%; width: 80%; margin-left: 10px;"></canvas>
                                    </div>
                                                                
                                    
                                    
                                    
                                    
                                </div>
                            </div>

                        </div>

                        <!-- <div class="grafico-caixa-2">
                        <h1 class="tituloAlerta">Quantidade de alertas mensais</h1>
                        <canvas id="Grafico3" class="grafico3" style="height: 20px; width: 50px;"></canvas>  -->
                            <!-- <div class="mãe">
                                <p></p>
                            </div> -->
                        </div>
                </div>
            </div>
        </div>
        
</div>
</body>
</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let graficoLinha = null;

window.onload = () => {
    atualizarGraficoTemp();
    criarGraficoPizza();
    criarGraficoBarras();
};

// Atualiza somente os dados do gráfico de linha

let dadosTemperaturaMédia = [];
var soma = 0;
var alertas = 0
let dadosTemperatura = [];
let labelsTempo = [];

function atualizarGraficoTemp() {
    fetch("/dashboard/temperaturaAtual")
        .then(res => {
            if (!res.ok) throw new Error(`Erro: ${res.status}`);
            return res.json();
        })
        .then(temperaturaAtual => {
            const ultimoRegistro = temperaturaAtual[temperaturaAtual.length - 1];

            // ADICIONANDO DADOS QUE VEM DA API DENTRO DOS VETORES
            if (!ultimoRegistro) return;
            dadosTemperatura.push(ultimoRegistro.temperatura);
            labelsTempo.push(formatarHora(ultimoRegistro.dtHora));

            // EXCLUINDO DADOS MAIS ANTIGOS DE DENTRO DOS VETORES
            if (dadosTemperatura.length > 10) {
                dadosTemperatura.shift();
                labelsTempo.shift();
            }

            if (!graficoLinha) {
                const ctx1 = document.getElementById('Grafico1').getContext('2d');
                graficoLinha = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: labelsTempo,
                        datasets: [{
                            label: 'Temperatura',
                            data: dadosTemperatura,
                            backgroundColor: '#DB6901',
                            borderColor: '#DB6901',
                            borderWidth: 3,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    font: { size: 15 }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } else {
                // ATIALIZANDO OS DADOS DE DENTRO DO GRAFICO
                graficoLinha.data.labels = labelsTempo;
                graficoLinha.data.datasets[0].data = dadosTemperatura;
                graficoLinha.update();
                kpis()
                temperaturaAtual
            }

            setTimeout(atualizarGraficoTemp, 5000); // Atualiza a cada 5 segundos


            function kpis(){
                var temperaturaAtual = ultimoRegistro.temperatura
                if(temperaturaAtual > 30){
                    console.log('AELRTA DE TEMPERATURA!', temperaturaAtual )
                    alertas += 1
                    console.log(alertas)
                    alerta_kpi.innerHTML = `${alertas}`
                }

               
                dadosTemperaturaMédia.push(temperaturaAtual);
                console.log('Cauculando temeperatura',dadosTemperaturaMédia)

                for(i = 0 ; i <= dadosTemperaturaMédia.length ; i++){
                    console.log('somando:',soma,'+',dadosTemperaturaMédia)
                    soma += dadosTemperaturaMédia[i]

                    if ( i = dadosTemperaturaMédia.length ){
                        var resultado = soma / i 
                    }
                    
                }

                
                temp_atual_media.innerHTML = `${resultado.toFixed(2)}°C`
                temp_atual.innerHTML = `${temperaturaAtual}°C`
            }
        })
        .catch(err => {
            console.error("Erro ao buscar temperatura:", err);
            setTimeout(atualizarGraficoTemp, 2500);
        });


}
// FORMATANDO DATA E HORA
function formatarHora(dataHoraString) {
    const data = new Date(dataHoraString);
    return data.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

window.onload = atualizarGraficoTemp;
function criarGraficoPizza() {
    const ctx2 = document.getElementById('Grafico2').getContext('2d');
    const dadosPizza = [12, 5]; 

    new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: ['Dias acima de 30°C', 'Dias entre 24°C e 26°C'], 
            datasets: [{
                data: dadosPizza,
                backgroundColor: ['rgb(10, 84, 54)', '#DB6901'],
                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)']
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: {
                    labels: {
                        font: { size: 15 }
                    }
                }
            }
        }
    });
}

function criarGraficoBarras() {
    const ctx3 = document.getElementById('Grafico3').getContext('2d');
    new Chart(ctx3, {
        type: 'bar',
        data: {
            labels: ['06:00','07:00','08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00'],
            datasets: [{
                label: 'Temperatura',
                data: [17, 17, 19, 20, 20, 23, 31, 27, 29, 25, 27],
                backgroundColor: '#DB6901',
                borderColor: '#DB6901',
                borderWidth: 1,
                barThickness: 40
            }]
        },
        options: {
            responsive: false,
            plugins: {
                legend: {
                    labels: {
                        font: { size: 15 }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}



</script>

